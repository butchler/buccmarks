<html>
<head>
<script src="persistence.js" type="application/javascript"></script>
<script src="persistence.store.sql.js" type="application/javascript"></script>
<script src="persistence.store.websql.js" type="application/javascript"></script>
<script src="db.js" type="application/javascript"></script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resample.js"></script>
<script>


function sendScreenshot(id, url, callbackWay){
	Bookmark.findBy('chromeId', id, function(obj){
		
		if (obj){
			console.log('Cache Hit:' + obj.chromeId);
			callbackWay({"answer": obj.chromeId, "img": obj.img});
		} else {
			console.log('Cache Miss:' + id);
			console.log('Falling back to Buccmarks Server: ' + id);
			
			$.ajax({
				type: 'GET',
				url: 'http://buccmarks-server.dev/bookmarks/g/' + $.URLEncode(url),
				success: function(data, textStatus, jqXHR){
					callbackWay({"answer": id, "img": data});
					
					if (data.length > 0){
						console.log('Hit on Buccmarks-Server: ' + id);
						console.log('Saving to Cache: ' + id);
						saveScreenshot(url, id, data);	
					} else {
						console.log('Miss on Buccmarks-Server: ' + id);
					}
				},
			});
			
		}
		
	});
}

function takeScreenshot(id, url) {
	
	// Using PNG, as it's going to be resized now.
	chrome.tabs.captureVisibleTab(null, { format: 'png', quality: 100 }, function(img) {
		saveScreenshot(url, id, img, postScreenshot);
	});

}

function saveScreenshot(url, id, img, callback){
	Resample(img, 350, 191, function (data){
		
			var n = new Bookmark();
			n.chromeId = id;
			n.img = data;
			persistence.add(n);
			persistence.flush(function(){
				console.log('Saved: ' + url + ' Size: ' + data.length);
			}); // this is async
			
			if (callback){
				callback(url, data);
			}
	
	});
}

function postScreenshot(url, img){	
	var data = {};
	
	data["bookmark[url]"] = url;
	data["bookmark[picture]"] = img;

	$.ajax({
		type: 'POST',
		url: 'http://buccmarks-server.dev/bookmarks',
		data: data,
		success: function(datas, textStatus, jqXHR){
			console.log('Posted: ' + url);
		},
	});
}

function deleteScreenshot(id){
	Bookmark.findBy('chromeId', id, function(del){
		if (del){
			persistence.remove(del);
			persistence.flush(function(){
				console.log('Removed: ' + id);
			});
		} else {
			console.log('Nothing to remove. Not found: ' + id);
		}
	});
}

var syncInProgress = false;

chrome.bookmarks.onImportBegan.addListener(function() {
	syncInProgress = true;
	console.log("Syncing!");
});

chrome.bookmarks.onImportEnded.addListener(function() {
	syncInProgress = false;
	console.log("Done syncing!");
});

// TODO: Chrome will fire this event even when it's syncing.
// Whithout proper distinction, we may take a snapshop of whah the
// the user is seeing when sync starts. Sucks, I know.
chrome.bookmarks.onCreated.addListener(function(id, bookmark) {
	if (!syncInProgress){
		takeScreenshot(id, bookmark.url);
	}
});

chrome.bookmarks.onRemoved.addListener(function(id, removeInfo) {
	deleteScreenshot(id);
});

chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
	console.log('Screenie request: ' + request.url);
    if (request.ask){
		sendScreenshot(request.ask, request.url, sendResponse)
	}
});

// Opening Buccmarks
chrome.browserAction.onClicked.addListener(function(tab) {

	var tabUrl = chrome.extension.getURL('bookmarks.html');
	
	chrome.tabs.create({url: tabUrl}, function(tab) {
      var targetId = tab.id;

      var initBookmarks = function(tabId, changedProps) {
        // We are waiting for the tab we opened to finish loading.
        // Check that the the tab's id matches the tab we opened,
        // and that the tab is done loading.
        if (tabId != targetId || changedProps.status != "complete")
          return;

        // Passing the above test means this is the event we were waiting for.
        // There is nothing we need to do for future onUpdated events, so we
        // use removeListner to stop geting called when onUpdated events fire.
        chrome.tabs.onUpdated.removeListener(initBookmarks);

        // Look through all views to find the window which will display
        // the screenshot.  The url of the tab which will display the
        // screenshot includes a query parameter with a unique id, which
        // ensures that exactly one view will have the matching URL.
        var views = chrome.extension.getViews();
        for (var i = 0; i < views.length; i++) {
          var view = views[i];
          if (view.location.href == tabUrl) {
            view.init();
            break;
          }
        }
      };
      chrome.tabs.onUpdated.addListener(initBookmarks);

    });
});
</script>
</head>
<body>
</body>
</html>
